<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>TaskFlow</title>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DESIGN SYSTEM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --accent: #5B5BD6;
  --accent-soft: #EEEEFF;
  --green: #22C55E;
  --red: #EF4444;
  --orange: #F59E0B;
  --text: #111827;
  --text2: #374151;
  --text3: #9CA3AF;
  --bg: #F8F9FC;
  --card: #FFFFFF;
  --card2: #F3F4F6;
  --sep: #E5E7EB;
  --nav: rgba(248,249,252,0.94);
  --tab: rgba(255,255,255,0.96);
  --r: 14px;
  --sb: env(safe-area-inset-bottom, 0px);
  --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 24px rgba(0,0,0,0.10);
}

/* THEME 2: Deep Dark */
body.th-dark {
  --accent: #818CF8;
  --accent-soft: #1E1B4B;
  --text: #F9FAFB;
  --text2: #E5E7EB;
  --text3: #6B7280;
  --bg: #0F0F14;
  --card: #1A1A24;
  --card2: #22222F;
  --sep: #2D2D3D;
  --nav: rgba(15,15,20,0.96);
  --tab: rgba(26,26,36,0.98);
}

/* THEME 3: Warm Sand */
body.th-warm {
  --accent: #D97706;
  --accent-soft: #FEF3C7;
  --text: #1C1917;
  --text2: #44403C;
  --text3: #A8A29E;
  --bg: #FAFAF8;
  --card: #FFFFFF;
  --card2: #FDF8F0;
  --sep: #E7E5E4;
  --nav: rgba(250,250,248,0.94);
  --tab: rgba(255,255,255,0.96);
}

*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;touch-action:pan-y}
html,body{overscroll-behavior:none;min-height:100dvh;background:var(--bg);color:var(--text)}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','Helvetica Neue',sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;overflow-x:hidden}
#app{max-width:430px;margin:0 auto;min-height:100dvh;position:relative;overflow:hidden}

/* NAV */
.nav{position:sticky;top:0;z-index:100;background:var(--nav);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);padding:env(safe-area-inset-top,0) 16px 0;border-bottom:1px solid var(--sep)}
.nav-inner{display:flex;align-items:center;gap:8px;height:52px}
.nav-title{font-size:20px;font-weight:700;letter-spacing:-.4px;flex:1;color:var(--text)}
.nav-user-row{display:flex;align-items:center;gap:6px}
.nav-username{font-size:13px;font-weight:600;color:var(--text2)}
.nav-icon-btn{width:32px;height:32px;border-radius:50%;background:var(--card2);border:1px solid var(--sep);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;position:relative;transition:background .15s}
.nav-icon-btn:active{background:var(--sep)}
.notif-dot{position:absolute;top:0;right:0;width:9px;height:9px;background:var(--red);border-radius:50%;border:2px solid var(--nav)}

/* TABS */
.tabs{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;z-index:200;background:var(--tab);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-top:1px solid var(--sep);display:flex;padding:6px 4px calc(6px + var(--sb))}
.tab{display:flex;flex-direction:column;align-items:center;gap:3px;flex:1;cursor:pointer;padding:5px 2px;border-radius:12px;transition:background .15s}
.tab-icon-wrap{width:36px;height:28px;border-radius:9px;display:flex;align-items:center;justify-content:center;transition:background .2s,transform .15s;font-size:18px}
.tab.active .tab-icon-wrap{background:var(--accent-soft);transform:scale(1.08)}
.tab-label{font-size:10px;font-weight:500;color:var(--text3);transition:color .15s;letter-spacing:.1px}
.tab.active .tab-label{color:var(--accent);font-weight:600}
.fab{position:fixed;bottom:calc(74px + var(--sb));right:16px;width:50px;height:50px;border-radius:50%;background:var(--accent);color:#fff;font-size:24px;border:none;cursor:pointer;box-shadow:0 4px 20px rgba(91,91,214,.4);display:flex;align-items:center;justify-content:center;z-index:150;transition:transform .18s,box-shadow .18s}
.fab:active{transform:scale(.9);box-shadow:0 2px 10px rgba(91,91,214,.3)}

/* PAGES & SWIPE */
.pages-wrap{display:flex;width:500%;transition:transform .32s cubic-bezier(.32,.72,0,1)}
.pages-wrap.no-anim{transition:none}
.page{width:20%;min-height:calc(100dvh - 53px - 56px - var(--sb));padding-bottom:80px;flex-shrink:0}

/* CARDS */
.card-group{background:var(--card);border-radius:var(--r);margin:0 14px 12px;overflow:hidden;box-shadow:var(--shadow);border:1px solid var(--sep)}
.sec-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--text3);padding:16px 14px 6px;display:flex;align-items:center;gap:7px}
.super-sec{font-size:14px;font-weight:700;color:var(--text2);padding:14px 14px 6px;display:flex;align-items:center;gap:6px}

/* TASK ITEM */
.task-item{display:flex;align-items:flex-start;gap:10px;padding:12px 14px;background:var(--card);border-bottom:1px solid var(--sep);cursor:pointer;transition:background .12s;position:relative;overflow:hidden}
.task-item:last-child{border-bottom:none}
.task-item:active{background:var(--card2)}
.task-item.completing{animation:crumple .42s cubic-bezier(.36,.07,.19,.97) forwards}
@keyframes crumple{
  0%{transform:scale(1) rotateZ(0);opacity:1;max-height:200px;margin-bottom:0;padding-top:12px;padding-bottom:12px}
  30%{transform:scale(.96) rotateZ(-1.5deg);filter:brightness(.9)}
  60%{transform:scale(.9,.7) rotateZ(2deg);opacity:.7;filter:brightness(.7)}
  85%{transform:scale(.7,.3) rotateZ(-3deg);opacity:.3;max-height:200px}
  100%{transform:scale(.6,.05) rotateZ(1deg);opacity:0;max-height:0;padding-top:0;padding-bottom:0;margin-bottom:0}
}
.color-bar{position:absolute;left:0;top:6px;bottom:6px;width:3px;border-radius:2px}
.task-body{flex:1;min-width:0;padding-left:3px}
.task-title-row{display:flex;align-items:baseline;gap:6px}
.task-title{font-size:15px;font-weight:500;line-height:1.35;color:var(--text)}
.task-title.done{text-decoration:line-through;color:var(--text3);font-weight:400}
.task-meta{font-size:12px;color:var(--text3);margin-top:4px;display:flex;gap:5px;flex-wrap:wrap;align-items:center}
.chk{width:22px;height:22px;border-radius:50%;border:2px solid var(--sep);flex-shrink:0;display:flex;align-items:center;justify-content:center;margin-top:1px;transition:all .2s;cursor:pointer;font-size:11px;background:var(--card)}
.chk.done{background:var(--green);border-color:var(--green);color:#fff}
.chk:active{transform:scale(.85)}
.prog-wrap{margin-top:5px;display:flex;align-items:center;gap:6px}
.prog-bg{flex:1;height:3px;background:var(--sep);border-radius:2px;overflow:hidden}
.prog-fill{height:100%;background:var(--green);border-radius:2px;transition:width .3s}
.prog-lbl{font-size:10px;color:var(--text3);font-weight:600;min-width:28px}

/* BADGES */
.badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:.2px}
.b-red{background:#FEE2E2;color:#DC2626}
.b-ora{background:#FEF3C7;color:#D97706}
.b-grn{background:#DCFCE7;color:#16A34A}
.b-blu{background:#DBEAFE;color:#2563EB}
.b-pur{background:#EDE9FE;color:#7C3AED}
.b-rec{background:#E0F2FE;color:#0284C7}

body.th-dark .b-red{background:#450A0A;color:#FCA5A5}
body.th-dark .b-ora{background:#451A03;color:#FCD34D}
body.th-dark .b-grn{background:#052E16;color:#86EFAC}
body.th-dark .b-blu{background:#0C1A40;color:#93C5FD}
body.th-dark .b-pur{background:#1E1040;color:#C4B5FD}
body.th-dark .b-rec{background:#0C2340;color:#7DD3FC}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;border:none;cursor:pointer;font-family:inherit;font-size:16px;font-weight:600;border-radius:12px;transition:opacity .15s,transform .12s;letter-spacing:-.1px}
.btn:active{opacity:.8;transform:scale(.98)}
.btn-p{background:var(--accent);color:#fff;padding:14px 20px;width:100%}
.btn-d{background:#FEE2E2;color:var(--red);padding:14px 20px;width:100%}
body.th-dark .btn-d{background:#450A0A;color:#FCA5A5}
.btn-g{background:transparent;color:var(--accent);padding:8px 0;font-weight:500;font-size:15px}
.btn-outline{background:transparent;border:1.5px solid var(--sep);color:var(--text2);padding:12px 20px;width:100%}

/* MODAL / SHEET */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:300;display:flex;align-items:flex-end;opacity:0;pointer-events:none;transition:opacity .22s;backdrop-filter:blur(4px)}
.ov.open{opacity:1;pointer-events:all}
.sheet{background:var(--card);border-radius:20px 20px 0 0;width:100%;max-height:92dvh;overflow-y:auto;padding-bottom:calc(20px + var(--sb));transform:translateY(100%);transition:transform .28s cubic-bezier(.32,.72,0,1)}
.ov.open .sheet{transform:translateY(0)}
.handle{width:36px;height:4px;background:var(--sep);border-radius:2px;margin:12px auto 4px}
.mhdr{display:flex;align-items:center;justify-content:space-between;padding:12px 16px 10px}
.mtitle{font-size:18px;font-weight:700;color:var(--text)}
.mclose{color:var(--accent);font-size:16px;font-weight:600;cursor:pointer;padding:4px 2px}

/* FORM FIELDS */
.fg{padding:0 16px 14px}
.fl{display:block;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--text3);margin-bottom:7px}
.fi{width:100%;background:var(--card2);border:1px solid var(--sep);border-radius:11px;padding:12px 14px;font-size:15px;color:var(--text);font-family:inherit;outline:none;transition:border-color .15s}
.fi:focus{border-color:var(--accent)}
.fi::placeholder{color:var(--text3)}
.fsel{width:100%;background:var(--card2);border:1px solid var(--sep);border-radius:11px;padding:12px 14px;font-size:15px;color:var(--text);font-family:inherit;outline:none;-webkit-appearance:none}
.seg{display:flex;background:var(--card2);border:1px solid var(--sep);border-radius:11px;padding:3px;gap:2px}
.seg-b{flex:1;padding:8px 4px;border:none;background:transparent;border-radius:8px;font-size:12px;font-weight:500;color:var(--text3);cursor:pointer;transition:all .15s;font-family:inherit}
.seg-b.on{background:var(--card);color:var(--text);font-weight:700;box-shadow:0 1px 3px rgba(0,0,0,.10)}
.toggle{width:48px;height:28px;border-radius:14px;background:var(--sep);position:relative;cursor:pointer;transition:background .2s;flex-shrink:0;border:none}
.toggle.on{background:var(--green)}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.22);transition:left .2s}
.toggle.on::after{left:23px}

/* AVATAR */
.av{border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;flex-shrink:0;overflow:hidden}
.av img{width:100%;height:100%;object-fit:cover}

/* DETAIL */
.detail-ov{position:fixed;inset:0;background:var(--bg);z-index:400;transform:translateX(100%);transition:transform .28s cubic-bezier(.32,.72,0,1);overflow-y:auto}
.detail-ov.open{transform:translateX(0)}
.detail-nav{position:sticky;top:0;background:var(--nav);backdrop-filter:blur(20px);padding:14px 16px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--sep);z-index:10}
.back{color:var(--accent);font-size:16px;cursor:pointer;font-weight:500;display:flex;align-items:center;gap:3px}

/* SUBTASKS */
.sub-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--sep);background:var(--card)}
.sub-item:last-child{border-bottom:none}
.sub-chk{width:19px;height:19px;border-radius:50%;border:2px solid var(--sep);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:10px;cursor:pointer;transition:all .2s}
.sub-chk.done{background:var(--green);border-color:var(--green);color:#fff}
.drag-h{color:var(--text3);font-size:16px;cursor:grab;touch-action:none;flex-shrink:0;opacity:.5}

/* POOL */
.pool-card{background:var(--card);border-radius:var(--r);margin:0 14px 10px;padding:14px 14px 12px;box-shadow:var(--shadow);border:1px solid var(--sep);cursor:pointer;transition:transform .15s}
.pool-card:active{transform:scale(.99)}

/* SHUFFLE EFFECT */
.shuffle-overlay{position:fixed;inset:0;z-index:9000;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.7);backdrop-filter:blur(12px);opacity:0;pointer-events:none;transition:opacity .3s}
.shuffle-overlay.show{opacity:1;pointer-events:all}
.shuffle-dice{font-size:72px;animation:rollDice .5s ease infinite alternate}
.shuffle-msg{color:#fff;font-size:20px;font-weight:700;margin-top:20px;text-align:center;padding:0 24px;line-height:1.4}
.shuffle-sub{color:rgba(255,255,255,.55);font-size:14px;margin-top:6px}
@keyframes rollDice{from{transform:rotateZ(-15deg) scale(.9)}to{transform:rotateZ(15deg) scale(1.05)}}

/* CALENDAR */
.cal-nav{display:flex;align-items:center;justify-content:space-between;padding:14px 14px 10px}
.cal-month{font-size:18px;font-weight:700}
.cal-btn{background:var(--card2);border:1px solid var(--sep);border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;color:var(--text2)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;padding:0 14px 10px}
.cal-dn{text-align:center;font-size:10px;font-weight:700;color:var(--text3);padding:4px 0;text-transform:uppercase;letter-spacing:.4px}
.cal-cell{min-height:40px;border-radius:9px;display:flex;flex-direction:column;align-items:center;padding:3px 2px;cursor:pointer;transition:background .12s}
.cal-cell:active{background:var(--card2)}
.cal-num{font-size:13px;font-weight:500;width:26px;height:26px;display:flex;align-items:center;justify-content:center;border-radius:50%}
.cal-num.today{background:var(--accent);color:#fff;font-weight:700}
.cal-num.other-month{color:var(--text3);font-weight:400}
.cal-num.sel{background:var(--accent-soft);color:var(--accent);font-weight:700}
.cal-dots{display:flex;gap:2px;flex-wrap:wrap;justify-content:center;margin-top:1px}
.cal-dot{width:4px;height:4px;border-radius:50%}

/* CHIP FILTER */
.filter-bar{display:flex;gap:7px;padding:8px 14px;overflow-x:auto;scrollbar-width:none}
.filter-bar::-webkit-scrollbar{display:none}
.chip{flex-shrink:0;padding:5px 13px;border-radius:20px;font-size:12px;font-weight:600;border:1.5px solid var(--sep);cursor:pointer;font-family:inherit;transition:all .15s;background:var(--card);color:var(--text3)}
.chip.on{border-color:var(--accent);background:var(--accent-soft);color:var(--accent)}

/* CELEBRATION */
.celeb-ov{position:fixed;inset:0;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(12px);opacity:0;pointer-events:none;transition:opacity .28s}
.celeb-ov.show{opacity:1;pointer-events:all}
.celeb-face{font-size:84px;animation:bounce .55s ease infinite alternate}
.celeb-txt{color:#fff;font-size:19px;font-weight:700;margin-top:16px;text-align:center;padding:0 28px;line-height:1.4}
.celeb-sub{color:rgba(255,255,255,.5);font-size:13px;margin-top:8px}
.conf{position:absolute;border-radius:2px;animation:fall linear forwards}
@keyframes bounce{from{transform:translateY(0) rotate(-6deg)}to{transform:translateY(-16px) rotate(6deg)}}
@keyframes fall{0%{transform:translateY(-30px) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(800deg);opacity:0}}

/* NOTIF OVERLAY */
.notif-ov{position:fixed;inset:0;z-index:8000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);backdrop-filter:blur(10px);opacity:0;pointer-events:none;transition:opacity .25s}
.notif-ov.show{opacity:1;pointer-events:all}
.notif-card{background:var(--card);border-radius:20px;padding:28px 22px 22px;max-width:320px;width:88%;text-align:center;box-shadow:var(--shadow-md)}
.notif-icon{font-size:52px;margin-bottom:10px}
.notif-title{font-size:17px;font-weight:700;margin-bottom:7px}
.notif-msg{font-size:14px;color:var(--text2);line-height:1.55;margin-bottom:18px}

/* TOAST */
.toast{position:fixed;bottom:calc(80px + var(--sb));left:50%;transform:translateX(-50%) translateY(10px);background:rgba(17,24,39,.92);color:#fff;padding:11px 18px;border-radius:12px;font-size:14px;font-weight:500;z-index:9999;white-space:nowrap;opacity:0;transition:opacity .25s,transform .25s;pointer-events:none;backdrop-filter:blur(12px);max-width:92vw;text-align:center}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* PHOTO */
.photo-area{width:64px;height:64px;border-radius:50%;background:var(--card2);border:2px dashed var(--sep);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;flex-shrink:0}
.photo-area img{width:100%;height:100%;object-fit:cover}

/* COLOR GRID - smaller */
.color-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:8px;padding:4px 0}
.cdot{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2.5px solid transparent;transition:transform .12s,border-color .12s}
.cdot.sel{border-color:var(--text);transform:scale(1.18)}

/* EMPTY STATE */
.empty{text-align:center;padding:48px 20px}
.empty-icon{font-size:48px;margin-bottom:12px}
.empty-title{font-size:19px;font-weight:700;margin-bottom:5px}
.empty-sub{font-size:14px;color:var(--text3)}

/* CARD ROW */
.card-row{display:flex;align-items:center;padding:13px 14px;gap:12px;border-bottom:1px solid var(--sep);cursor:pointer;transition:background .12s}
.card-row:last-child{border-bottom:none}
.card-row:active{background:var(--card2)}
.chevron{color:var(--text3);font-size:16px}

/* ADMIN */
.admin-row{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:background .15s}
.admin-row:active{background:rgba(239,68,68,.14)}

/* ONBOARDING */
.onboard{position:fixed;inset:0;z-index:10000;background:var(--bg);display:flex;flex-direction:column;padding:env(safe-area-inset-top,24px) 20px 20px;overflow-y:auto}
.onboard.hidden{display:none}
.ob-logo{font-size:52px;margin:20px 0 12px}
.ob-title{font-size:28px;font-weight:800;letter-spacing:-.6px;margin-bottom:6px}
.ob-sub{font-size:15px;color:var(--text3);line-height:1.55;margin-bottom:28px}
.ob-card{background:var(--card);border:1px solid var(--sep);border-radius:14px;padding:16px;margin-bottom:10px;cursor:pointer;transition:all .15s;box-shadow:var(--shadow)}
.ob-card:active{transform:scale(.99);background:var(--card2)}
.ob-card-title{font-size:15px;font-weight:700;margin-bottom:3px}
.ob-card-sub{font-size:13px;color:var(--text3)}

/* NEW SUB INPUT */
.sub-input-row{display:flex;gap:7px;margin-top:8px}
.sub-input-row input{flex:1;background:var(--card2);border:1px solid var(--sep);border-radius:10px;padding:10px 12px;font-size:14px;color:var(--text);font-family:inherit;outline:none}
.sub-input-row button{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-size:14px;font-weight:600;cursor:pointer}
.new-sub-tag{display:flex;align-items:center;gap:7px;background:var(--card2);border:1px solid var(--sep);border-radius:9px;padding:8px 10px;margin-top:6px}
.rm-btn{background:none;border:none;color:var(--text3);font-size:17px;cursor:pointer;line-height:1;padding:0 2px}

/* DRAG CAT */
.drag-cat-h{color:var(--text3);font-size:13px;cursor:grab;touch-action:none;opacity:.5}
.cat-block{transition:opacity .12s}
.cat-block.dragging{opacity:.4}

/* SECTION DIVIDER */
.divider{height:1px;background:var(--sep);margin:4px 14px}
</style>
</head>
<body>

<!-- ONBOARDING -->
<div class="onboard" id="onboard">
  <div class="ob-logo">âœ…</div>
  <div class="ob-title">TaskFlow</div>
  <div class="ob-sub">Gemeinsam mehr erledigen.<br>Erstelle dein Profil und starte.</div>

  <div id="ob-step1">
    <label class="fl" style="margin-bottom:8px">Dein Name</label>
    <input class="fi" id="ob-name" placeholder="Name eingebenâ€¦" style="margin-bottom:14px;font-size:17px" onkeydown="if(event.key==='Enter')obNext()">
    <button class="btn btn-p" onclick="obNext()">Weiter</button>
  </div>

  <div id="ob-step2" style="display:none">
    <div class="ob-card" onclick="obChoose('solo')">
      <div class="ob-card-title">ğŸ‘¤ Nur fÃ¼r mich</div>
      <div class="ob-card-sub">Aufgaben nur fÃ¼r dich, kein anderer hat Zugriff</div>
    </div>
    <div class="ob-card" onclick="obChoose('create')">
      <div class="ob-card-title">ğŸ  Neue Gruppe erstellen</div>
      <div class="ob-card-sub">z.B. Haushalt, Familie oder Team</div>
    </div>
    <div class="ob-card" onclick="obChoose('join')">
      <div class="ob-card-title">ğŸ”— Gruppe beitreten</div>
      <div class="ob-card-sub">Mit Einladungscode einer Gruppe beitreten</div>
    </div>
    <button class="btn btn-g" style="margin-top:6px;display:block" onclick="ob1()">â† ZurÃ¼ck</button>
  </div>

  <div id="ob-step3-create" style="display:none">
    <div style="font-size:15px;font-weight:700;margin-bottom:14px">ğŸ  Gruppe erstellen</div>
    <input class="fi" id="ob-group-name" placeholder="Gruppennameâ€¦" style="margin-bottom:12px">
    <button class="btn btn-p" onclick="obCreateGroup()">Erstellen</button>
    <button class="btn btn-g" style="display:block;margin-top:8px" onclick="ob2()">â† ZurÃ¼ck</button>
  </div>

  <div id="ob-step3-join" style="display:none">
    <div style="font-size:15px;font-weight:700;margin-bottom:14px">ğŸ”— Gruppe beitreten</div>
    <input class="fi" id="ob-invite" placeholder="Einladungscodeâ€¦" style="margin-bottom:12px;text-transform:uppercase;letter-spacing:2px">
    <button class="btn btn-p" onclick="obJoinGroup()">Beitreten</button>
    <button class="btn btn-g" style="display:block;margin-top:8px" onclick="ob2()">â† ZurÃ¼ck</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none">
  <div class="nav">
    <div class="nav-inner">
      <div class="nav-title" id="navTitle">Meine Aufgaben</div>
      <div class="nav-user-row">
        <span class="nav-username" id="navUsername"></span>
        <button class="nav-icon-btn" onclick="openProfile()" id="avatarBtn">ğŸ‘¤<span class="notif-dot" id="notifDot" style="display:none"></span></button>
        <button class="nav-icon-btn" onclick="openSettings()">âš™ï¸</button>
      </div>
    </div>
  </div>

  <!-- SWIPEABLE PAGES -->
  <div id="pagesWrap" class="pages-wrap">
    <!-- PAGE 0: MY TASKS -->
    <div class="page" id="pageMy">
      <div id="myTasksContainer"></div>
      <div style="padding:0 14px 4px">
        <div class="card-group" style="margin:0">
          <div class="card-row" onclick="toggleDoneFilter()" style="cursor:pointer">
            <span style="flex:1;font-size:14px;font-weight:500;color:var(--text2)">Erledigte anzeigen</span>
            <div class="toggle" id="toggleDone"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- PAGE 1: ALL -->
    <div class="page" id="pageAll">
      <div class="filter-bar" id="allFilterBar"></div>
      <div id="allTasksContainer"></div>
    </div>

    <!-- PAGE 2: POOL -->
    <div class="page" id="pagePool">
      <div style="padding:14px 14px 0;display:flex;align-items:center;justify-content:space-between">
        <div><div style="font-size:18px;font-weight:700">Aufgaben-Pool</div><div style="font-size:12px;color:var(--text3);margin-top:1px">ZufÃ¤llig zugewiesen</div></div>
      </div>
      <div style="padding:10px 14px 0">
        <button class="btn btn-p" onclick="shufflePool()" style="font-size:14px;padding:11px 16px">ğŸ² Neu mischen</button>
      </div>
      <div class="filter-bar" id="poolFilterBar"></div>
      <div id="poolContainer"></div>
    </div>

    <!-- PAGE 3: CALENDAR -->
    <div class="page" id="pageCalendar">
      <div class="cal-nav">
        <button class="cal-btn" onclick="calPrev()">â€¹</button>
        <div class="cal-month" id="calMonthLabel"></div>
        <button class="cal-btn" onclick="calNext()">â€º</button>
      </div>
      <div class="cal-grid" id="calGrid"></div>
      <div id="calTaskList"></div>
    </div>

    <!-- PAGE 4: GROUP/USERS -->
    <div class="page" id="pageUsers">
      <div id="groupContainer" style="padding-top:6px"></div>
      <div class="sec-label">Mitglieder</div>
      <div id="usersContainer"></div>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab(0)" id="tab0">
      <div class="tab-icon-wrap">âœ…</div>
      <span class="tab-label">Meine</span>
    </div>
    <div class="tab" onclick="switchTab(1)" id="tab1">
      <div class="tab-icon-wrap">ğŸ“‹</div>
      <span class="tab-label">Alle</span>
    </div>
    <div class="tab" onclick="switchTab(2)" id="tab2">
      <div class="tab-icon-wrap">ğŸ²</div>
      <span class="tab-label">Pool</span>
    </div>
    <div class="tab" onclick="switchTab(3)" id="tab3">
      <div class="tab-icon-wrap">ğŸ“…</div>
      <span class="tab-label">Kalender</span>
    </div>
    <div class="tab" onclick="switchTab(4)" id="tab4">
      <div class="tab-icon-wrap">ğŸ‘¥</div>
      <span class="tab-label">Gruppe</span>
    </div>
  </div>
  <button class="fab" id="fabBtn" onclick="showAddTask()">+</button>
</div>

<!-- OVERLAYS -->
<div class="toast" id="toast"></div>

<div class="celeb-ov" id="celebOv" onclick="closeceleb()">
  <div id="confContainer" style="position:absolute;inset:0;overflow:hidden;pointer-events:none"></div>
  <div class="celeb-face" id="celebFace">ğŸ˜„</div>
  <div class="celeb-txt" id="celebTxt"></div>
  <div class="celeb-sub">Tippe um fortzufahren</div>
</div>

<div class="notif-ov" id="notifOv" onclick="closeNotifOv()">
  <div class="notif-card" onclick="event.stopPropagation()">
    <div class="notif-icon" id="notifOvIcon">ğŸ””</div>
    <div class="notif-title" id="notifOvTitle"></div>
    <div class="notif-msg" id="notifOvMsg"></div>
    <button class="btn btn-p" onclick="closeNotifOv()">OK!</button>
  </div>
</div>

<div class="shuffle-overlay" id="shuffleOv" onclick="closeShuffleOv()">
  <div class="shuffle-dice" id="shuffleDice">ğŸ²</div>
  <div class="shuffle-msg" id="shuffleMsg"></div>
  <div class="shuffle-sub">Tippe um fortzufahren</div>
</div>

<!-- TASK MODAL -->
<div class="ov" id="taskModal">
  <div class="sheet">
    <div class="handle"></div>
    <div class="mhdr"><div class="mtitle" id="modalTitle">Neue Aufgabe</div><span class="mclose" onclick="closeTaskModal()">Fertig</span></div>
    <div class="fg"><label class="fl">Titel</label><input class="fi" id="taskTitle" placeholder="Aufgabe eingebenâ€¦"></div>
    <div class="fg"><label class="fl">Beschreibung</label><textarea class="fi" id="taskDesc" rows="2" placeholder="Detailsâ€¦" style="resize:none"></textarea></div>
    <div class="fg"><label class="fl">Kategorie</label><select class="fsel" id="taskCat"></select></div>
    <div class="fg"><label class="fl">PrioritÃ¤t</label>
      <div class="seg" id="prioCtrl">
        <button class="seg-b" onclick="setPrio('Hoch',this)">ğŸ”´ Hoch</button>
        <button class="seg-b on" onclick="setPrio('Mittel',this)">ğŸŸ¡ Mittel</button>
        <button class="seg-b" onclick="setPrio('Niedrig',this)">ğŸŸ¢ Niedrig</button>
      </div>
    </div>
    <div class="fg"><label class="fl">Deadline</label><input class="fi" id="taskDeadline" type="date"></div>
    <div class="fg"><label class="fl">ZustÃ¤ndig</label><select class="fsel" id="taskAssignee" onchange="onAssigneeChange(this)"></select></div>
    <div class="fg"><label class="fl">Wiederholt sich</label>
      <select class="fsel" id="taskRepeat"><option>Nie</option><option>TÃ¤glich</option><option>WÃ¶chentlich</option><option>Monatlich</option></select>
    </div>
    <div class="fg"><div style="display:flex;align-items:center;justify-content:space-between"><label class="fl" style="margin:0">Im Pool anzeigen</label><div class="toggle" id="poolToggle" onclick="this.classList.toggle('on')"></div></div></div>
    <div class="fg">
      <label class="fl">Unteraufgaben</label>
      <div id="newSubList"></div>
      <div class="sub-input-row"><input type="text" id="newSubInput" placeholder="Unteraufgabeâ€¦" onkeydown="if(event.key==='Enter'){addNewSub();event.preventDefault()}"><button onclick="addNewSub()">+</button></div>
    </div>
    <div style="padding:0 16px 8px"><button class="btn btn-p" onclick="saveTask()">Speichern</button></div>
    <div style="padding:0 16px 4px" id="delTaskRow"></div>
  </div>
</div>

<!-- PROFILE MODAL -->
<div class="ov" id="profileModal">
  <div class="sheet">
    <div class="handle"></div>
    <div class="mhdr"><div class="mtitle">Mein Profil</div><span class="mclose" onclick="closeProfile()">Fertig</span></div>
    <div class="fg">
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:4px">
        <div class="photo-area" id="profilePhotoArea" onclick="document.getElementById('profilePhotoInput').click()"></div>
        <input type="file" id="profilePhotoInput" accept="image/*" style="display:none" onchange="handleProfilePhoto(this)">
        <div style="flex:1"><label class="fl">Name</label><input class="fi" id="profileName" placeholder="Nameâ€¦"></div>
      </div>
    </div>
    <div class="fg"><label class="fl">Meine Farbe</label><div class="color-grid" id="profileColorGrid"></div></div>
    <div class="fg">
      <label class="fl">App-Design</label>
      <div class="seg" id="themeSegCtrl">
        <button class="seg-b on" onclick="setThemeFromProfile('','',this)">Hell</button>
        <button class="seg-b" onclick="setThemeFromProfile('th-dark','',this)">Dunkel</button>
        <button class="seg-b" onclick="setThemeFromProfile('th-warm','',this)">Warm</button>
      </div>
    </div>
    <div class="fg" id="colorOverrideSection"></div>
    <div class="fg" id="groupInfoSection"></div>
    <div class="fg">
      <div class="admin-row" onclick="openAdminModal()">
        <span style="font-size:20px">ğŸ”</span>
        <div style="flex:1"><div style="font-size:14px;font-weight:600;color:var(--red)">Admin-Bereich</div><div style="font-size:12px;color:var(--text3)">Nur mit PIN zugÃ¤nglich</div></div>
        <span class="chevron">â€º</span>
      </div>
    </div>
    <div style="padding:0 16px 8px"><button class="btn btn-p" onclick="saveProfile()">Speichern</button></div>
    <div style="padding:0 16px 8px" id="leaveGroupRow"></div>
    <div style="padding:0 16px 12px"><button class="btn btn-d" onclick="deleteAccount()">Account lÃ¶schen</button></div>
  </div>
</div>

<!-- ADMIN MODAL -->
<div class="ov" id="adminModal">
  <div class="sheet">
    <div class="handle"></div>
    <div class="mhdr"><div class="mtitle">ğŸ” Admin-Bereich</div><span class="mclose" onclick="closeAdminModal()">SchlieÃŸen</span></div>
    <div id="adminContent">
      <div class="fg">
        <label class="fl">Admin-PIN eingeben</label>
        <input class="fi" id="adminPinInput" type="password" placeholder="PINâ€¦" inputmode="numeric" maxlength="12">
        <div style="margin-top:10px"><button class="btn btn-p" onclick="verifyAdminPin()">BestÃ¤tigen</button></div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="ov" id="settingsOv">
  <div class="sheet">
    <div class="handle"></div>
    <div class="mhdr"><div class="mtitle">Einstellungen</div><span class="mclose" onclick="closeSettings()">Fertig</span></div>
    <div class="sec-label">Eigene Kategorien</div>
    <div id="customCatList" style="padding:0 14px 8px"></div>
    <div style="padding:0 14px 16px;display:flex;gap:7px">
      <input class="fi" id="newCatEmoji" placeholder="ğŸ˜€" style="width:52px;text-align:center;padding:10px 8px">
      <input class="fi" id="newCatName" placeholder="Kategorie Nameâ€¦" style="flex:1;padding:10px 12px">
      <button class="btn" style="background:var(--accent);color:#fff;padding:10px 12px;font-size:14px;border-radius:11px" onclick="addCustomCat()">+</button>
    </div>
    <div class="sec-label">Daten</div>
    <div style="padding:0 14px 20px">
      <button class="btn btn-d" style="font-size:14px" onclick="resetTasks()">ğŸ—‘ï¸ Alle Aufgaben zurÃ¼cksetzen</button>
    </div>
  </div>
</div>

<!-- TASK DETAIL -->
<div class="detail-ov" id="taskDetail">
  <div class="detail-nav">
    <span class="back" onclick="closeDetail()">â€¹ ZurÃ¼ck</span>
    <span style="flex:1"></span>
    <span style="color:var(--accent);cursor:pointer;font-size:15px;font-weight:600" onclick="editCurrentTask()">Bearbeiten</span>
</div>
  <div id="taskDetailContent"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_CATS = {Arbeit:'ğŸ’¼',Haushalt:'ğŸ ',Einkauf:'ğŸ›’',Gesundheit:'â¤ï¸',Freizeit:'ğŸ¯',Schule:'ğŸ“š',Sonstiges:'ğŸ“Œ'};
const ALL_COLORS = ['#5B5BD6','#7C3AED','#DB2777','#DC2626','#EA580C','#CA8A04','#16A34A','#0891B2','#2563EB','#9333EA','#EC4899','#EF4444','#F97316','#EAB308','#22C55E','#06B6D4','#3B82F6','#6366F1','#A855F7','#F43F5E','#FB923C','#FBBF24','#4ADE80','#22D3EE'];
const PRIO_CLASS = {Hoch:'b-red',Mittel:'b-ora',Niedrig:'b-grn'};
const CELEB_MSGS = ['Jawoll! Das hast du richtig gut gemacht!','Erledigt! Du bist ein Star!','Einfach top, weiter so!','Aufgabe gecrusht! Champion!','Stark! Diese Aufgabe hatte keine Chance!','Abgehakt! Du machst das super!'];
const SHUFFLE_MSGS = ['Die WÃ¼rfel sind gefallen! ğŸ²','Aufgaben sind verteilt!','Frisch gemischt â€“ viel Erfolg!','Neue Runde, neue Chancen!','Los geht\'s â€“ wer zieht was?'];
const NAV_TITLES = ['Meine Aufgaben','Alle Aufgaben','Pool','Kalender','Gruppe'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let me = null, myToken = null, users = [], tasks = [], group = null, appstate = {};
let selectedPrio = 'Mittel', newSubs = [], editingTaskId = null, currentDetailId = null;
let calYear = new Date().getFullYear(), calMonth = new Date().getMonth(), calSelectedDay = null;
let profilePhotoData = null, pollHash = null, pollTimer = null, currentTab = 0;
let verifiedAdminPin = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json', 'x-token': myToken || '' } };
  if (body !== undefined) opts.body = JSON.stringify(body);
  const r = await fetch('/api' + path, opts);
  if (!r.ok) { const e = await r.json().catch(() => ({})); throw new Error(e.error || r.statusText); }
  return r.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  myToken = localStorage.getItem('tf_token');
  if (myToken) {
    try {
      me = await api('GET', '/users/me');
      await loadAll(); showApp(); startPolling(); return;
    } catch(e) { localStorage.removeItem('tf_token'); myToken = null; }
  }
  showOnboard();
}

function showOnboard() { document.getElementById('onboard').classList.remove('hidden'); document.getElementById('app').style.display = 'none'; }
function showApp() {
  document.getElementById('onboard').classList.add('hidden');
  document.getElementById('app').style.display = 'block';
  applyTheme(); render(); checkNotifs();
}

async function loadAll() {
  [users, tasks, group] = await Promise.all([
    api('GET', '/users'),
    api('GET', '/tasks'),
    api('GET', '/groups/mine').catch(() => null)
  ]);
  try { appstate = await api('GET', '/appstate'); } catch(e) { appstate = {}; }
  appstate = { catOrder:[], poolTasks:[], poolAssignments:{}, customCats:{}, showDone:false, showDoneAll:false, poolFilter:'all', ...appstate };
  processRecurring();
}

async function saveAppstate() { try { await api('POST', '/appstate', appstate); } catch(e) {} }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ONBOARDING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ob1() { ['ob-step1','ob-step2','ob-step3-create','ob-step3-join'].forEach(id => { const el = document.getElementById(id); if(el) el.style.display = id==='ob-step1'?'block':'none'; }); }
function ob2() { ['ob-step1','ob-step2','ob-step3-create','ob-step3-join'].forEach(id => { const el = document.getElementById(id); if(el) el.style.display = id==='ob-step2'?'block':'none'; }); }
function obNext() { const n = document.getElementById('ob-name').value.trim(); if (!n) { showToast('Name eingeben'); return; } document.getElementById('ob-step1').style.display='none'; document.getElementById('ob-step2').style.display='block'; }
async function obChoose(c) {
  const name = document.getElementById('ob-name').value.trim();
  await doLogin(name);
  document.getElementById('ob-step2').style.display='none';
  if (c==='solo') { await api('PATCH','/users/me',{solo:true}); me.solo=true; await loadAll(); showApp(); startPolling(); }
  else { document.getElementById(c==='create'?'ob-step3-create':'ob-step3-join').style.display='block'; }
}
async function doLogin(name) { const d = await api('POST','/users/login',{username:name}); myToken=d.token; localStorage.setItem('tf_token',myToken); me=await api('GET','/users/me'); }
async function obCreateGroup() {
  const name = document.getElementById('ob-group-name').value.trim(); if (!name) { showToast('Name eingeben'); return; }
  group = await api('POST','/groups',{name}); me = await api('GET','/users/me'); await loadAll(); showApp(); startPolling();
  showToast('ğŸ  Gruppe erstellt! Code: '+group.inviteCode);
}
async function obJoinGroup() {
  const code = document.getElementById('ob-invite').value.trim().toUpperCase(); if (!code) { showToast('Code eingeben'); return; }
  try { group = await api('POST','/groups/join',{inviteCode:code}); me=await api('GET','/users/me'); await loadAll(); showApp(); startPolling(); showToast('ğŸ‰ Gruppe beigetreten!'); }
  catch(e) { showToast('Fehler: '+e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POLLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startPolling() {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async () => {
    try {
      const r = await api('GET','/poll');
      if (r.hash !== pollHash) { pollHash=r.hash; await loadAll(); render(); }
      document.getElementById('notifDot').style.display = r.hasNotifications ? 'block' : 'none';
      if (r.hasNotifications) checkNotifs();
    } catch(e) {}
  }, 5000);
}
async function checkNotifs() {
  try {
    const notifs = await api('GET','/users/notifications');
    if (notifs?.length) { showNotifOverlay(notifs[0]); await api('DELETE','/users/notifications'); document.getElementById('notifDot').style.display='none'; }
  } catch(e) {}
}
function showNotifOverlay(n) {
  document.getElementById('notifOvIcon').textContent = n.type==='task_done'?'ğŸ‰':'ğŸ“‹';
  document.getElementById('notifOvTitle').textContent = n.type==='task_done'?'Aufgabe erledigt!':'Neue Aufgabe!';
  document.getElementById('notifOvMsg').textContent = n.text;
  document.getElementById('notifOv').classList.add('show');
}
function closeNotifOv() { document.getElementById('notifOv').classList.remove('show'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyTheme() {
  const userTheme = me?.theme || '';
  document.body.className = userTheme;
}
function setThemeFromProfile(cls, accent, btn) {
  me.theme = cls;
  applyTheme();
  document.querySelectorAll('#themeSegCtrl .seg-b').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECURRING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function todayStr() { return new Date().toISOString().split('T')[0]; }
function weekStart(d) { const dt=new Date(d+'T00:00:00'),day=dt.getDay(),diff=day===0?-6:1-day; dt.setDate(dt.getDate()+diff); return dt.toISOString().split('T')[0]; }
function monthStart(d) { return d.slice(0,8)+'01'; }
function processRecurring() {
  const today=todayStr(); if (!appstate.recurringLastRun) appstate.recurringLastRun={};
  let changed=false;
  tasks.forEach(t => {
    if (!t.repeat||t.repeat==='Nie'||!t.done) return;
    const last=appstate.recurringLastRun[t._id]||today; let reset=false;
    if (t.repeat==='TÃ¤glich'&&last<today) reset=true;
    if (t.repeat==='WÃ¶chentlich'&&weekStart(last)<weekStart(today)) reset=true;
    if (t.repeat==='Monatlich'&&monthStart(last)<monthStart(today)) reset=true;
    if (reset) { appstate.recurringLastRun[t._id]=today; api('PATCH','/tasks/'+t._id,{done:false,subtasks:(t.subtasks||[]).map(s=>({...s,done:false}))}); t.done=false; if(t.subtasks)t.subtasks.forEach(s=>s.done=false); changed=true; }
  });
  if (changed) saveAppstate();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  if (!me) return;
  document.getElementById('navUsername').textContent = me.name;
  const av = me.photo ? `<img src="${me.photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">` : `<span style="font-size:13px;font-weight:700;color:${me.color}">${me.name[0]}</span>`;
  document.getElementById('avatarBtn').innerHTML = av + `<span class="notif-dot" id="notifDot" style="display:none"></span>`;
  renderMyTasks(); renderAllTasks(); renderPool(); renderCalendar(); renderUsers();
}

function allCats() { return { ...DEFAULT_CATS, ...(appstate.customCats||{}) }; }
function catIcon(c) { return allCats()[c]||'ğŸ“Œ'; }
function userById(id) { return users.find(u => u._id?.toString()===id?.toString()); }
function userColor(assignee) {
  if (assignee==='all') return '#9CA3AF';
  const ovr = me?.colorOverrides?.[assignee]; if (ovr) return ovr;
  const u = userById(assignee); return u?.color||'#9CA3AF';
}
function avatarHTML(u, size=38) {
  if (!u) return `<div class="av" style="width:${size}px;height:${size}px;background:#9CA3AF;font-size:${Math.round(size*.38)}px">?</div>`;
  if (u.photo) return `<div class="av" style="width:${size}px;height:${size}px"><img src="${u.photo}"></div>`;
  return `<div class="av" style="width:${size}px;height:${size}px;background:${u.color||'#9CA3AF'};font-size:${Math.round(size*.38)}px">${u.name?.[0]||'?'}</div>`;
}
function progHTML(t) {
  if (!t.subtasks?.length) return '';
  const done=t.subtasks.filter(s=>s.done).length,total=t.subtasks.length;
  return `<div class="prog-wrap"><div class="prog-bg"><div class="prog-fill" style="width:${Math.round(done/total*100)}%"></div></div><span class="prog-lbl">${done}/${total}</span></div>`;
}
function taskHTML(t, showBar=false) {
  const col=userColor(t.assignee), u=userById(t.assignee);
  const aname = t.assignee==='all'?'Alle':(u?u.name:'');
  const overdue = t.deadline&&!t.done&&new Date(t.deadline+'T00:00:00')<new Date();
  return `<div class="task-item" id="ti-${t._id}" onclick="openDetail('${t._id}')">
    ${showBar?`<div class="color-bar" style="background:${col}"></div>`:''}
    <div class="chk ${t.done?'done':''}" onclick="event.stopPropagation();toggleTask('${t._id}',true)">${t.done?'âœ“':''}</div>
    <div class="task-body">
      <div class="task-title ${t.done?'done':''}">${t.title}</div>
      <div class="task-meta">
        <span class="badge ${PRIO_CLASS[t.prio]||'b-ora'}">${t.prio}</span>
        ${t.deadline?`<span style="color:${overdue?'var(--red)':'var(--text3)'}">ğŸ“… ${fmtDate(t.deadline)}${overdue?' âš ï¸':''}</span>`:''}
        ${t.repeat&&t.repeat!=='Nie'?`<span class="badge b-rec">ğŸ” ${t.repeat}</span>`:''}
        ${showBar&&aname?`<span style="color:${col};font-weight:600">${aname}</span>`:''}
      </div>
      ${progHTML(t)}
    </div>
    <span class="chevron">â€º</span>
  </div>`;
}

// â”€â”€ MY TASKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isRandomTask(t) {
  if (t.assignee===me._id?.toString()) return false;
  if (t.assignee==='all') return true;
  const asgn=appstate.poolAssignments?.[t._id?.toString()];
  return !!(asgn&&asgn.assignedUser===me._id?.toString());
}
function visibleToMe(t) {
  if (t.assignee===me._id?.toString()) return true;
  if (t.assignee==='all') return true;
  const asgn=appstate.poolAssignments?.[t._id?.toString()];
  return !!(asgn&&asgn.assignedUser===me._id?.toString());
}

function renderMyTasks() {
  const showDone=appstate.showDone;
  document.getElementById('toggleDone').className='toggle'+(showDone?' on':'');
  const mine=tasks.filter(t=>!isRandomTask(t)&&t.assignee===me._id?.toString()&&(showDone||!t.done));
  const rand=tasks.filter(t=>isRandomTask(t)&&(showDone||!t.done));
  const c=document.getElementById('myTasksContainer');
  if (!mine.length&&!rand.length) { c.innerHTML=`<div class="empty"><div class="empty-icon">âœ…</div><div class="empty-title">Alles erledigt!</div><div class="empty-sub">Keine Aufgaben fÃ¼r dich.</div></div>`; return; }
  let html='';
  if (mine.length) {
    html+=`<div class="super-sec">ğŸ‘¤ Eigene Aufgaben</div>`;
    getOrderedCats(mine).forEach(cat => {
      const ct=mine.filter(t=>t.cat===cat); if(!ct.length) return;
      html+=`<div class="cat-block" data-cat="${cat}">
        <div class="sec-label"><span class="drag-cat-h">â ¿</span>${catIcon(cat)} ${cat}</div>
        <div class="card-group">${ct.map(t=>taskHTML(t,false)).join('')}</div>
      </div>`;
    });
  }
  if (rand.length) { html+=`<div class="super-sec">ğŸ² Random Aufgaben</div><div class="card-group">${rand.map(t=>taskHTML(t,true)).join('')}</div>`; }
  c.innerHTML=html; initCatDrag();
}
function getOrderedCats(list) {
  const found=[...new Set(list.map(t=>t.cat))];
  const ord=(appstate.catOrder||[]).filter(c=>found.includes(c));
  found.forEach(c=>{if(!ord.includes(c))ord.push(c);}); return ord;
}
function initCatDrag() {
  const wrap=document.getElementById('myTasksContainer'); let dr=null;
  function getBlocks(){return[...wrap.querySelectorAll('.cat-block')];}
  function start(e){const h=e.target.closest('.drag-cat-h');if(!h)return;e.preventDefault();dr=h.closest('.cat-block');if(dr)dr.classList.add('dragging');}
  function move(e){if(!dr)return;e.preventDefault();const y=e.touches?e.touches[0].clientY:e.clientY;const bl=getBlocks().filter(b=>b!==dr);let t=null;for(const b of bl){const r=b.getBoundingClientRect();if(y<r.top+r.height/2){t=b;break;}}if(t)wrap.insertBefore(dr,t);else wrap.appendChild(dr);}
  function end(){if(!dr)return;dr.classList.remove('dragging');appstate.catOrder=getBlocks().map(b=>b.dataset.cat);saveAppstate();dr=null;}
  wrap.addEventListener('touchstart',start,{passive:false});wrap.addEventListener('touchmove',move,{passive:false});wrap.addEventListener('touchend',end);
  wrap.addEventListener('mousedown',start);wrap.addEventListener('mousemove',move);wrap.addEventListener('mouseup',end);
}

// â”€â”€ ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAllTasks() {
  const sd=appstate.showDoneAll;
  document.getElementById('allFilterBar').innerHTML=`<button class="chip${!sd?' on':''}" onclick="setAllFilter(false)">Offen</button><button class="chip${sd?' on':''}" onclick="setAllFilter(true)">Alle</button>`;
  const list=tasks.filter(t=>sd||!t.done);
  const c=document.getElementById('allTasksContainer');
  if(!list.length){c.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">Keine Aufgaben</div></div>`;return;}
  c.innerHTML=`<div class="card-group">${list.map(t=>taskHTML(t,true)).join('')}</div>`;
}
function setAllFilter(v){appstate.showDoneAll=v;saveAppstate();renderAllTasks();}

// â”€â”€ POOL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPoolAssignments(ids) {
  const asgns={},uids=users.map(u=>u._id?.toString());
  if(!uids.length) return asgns;
  let idx=Math.floor(Math.random()*uids.length);
  ids.forEach(id=>{
    const t=tasks.find(t=>t._id?.toString()===id);if(!t)return;
    if(t.assignee!=='all'){asgns[id]={assignedUser:t.assignee,subtaskAssignments:{}};return;}
    const last=appstate.poolAssignments?.[id]?.assignedUser;
    const subA={};
    (t.subtasks||[]).forEach(s=>{subA[s.id]=uids[idx%uids.length];idx++;});
    let main=uids[idx%uids.length];
    if(uids.length>1&&main===last){idx++;main=uids[idx%uids.length];}
    idx++;
    asgns[id]={assignedUser:main,subtaskAssignments:subA};
  });
  return asgns;
}

function renderPool() {
  const pf=appstate.poolFilter||'all';
  document.getElementById('poolFilterBar').innerHTML=`<button class="chip${pf==='all'?' on':''}" onclick="setPoolFilter('all')">Alle</button>`+
    users.map(u=>`<button class="chip${pf===u._id?.toString()?' on':''}" onclick="setPoolFilter('${u._id}')">${u.name}</button>`).join('');
  const poolable=tasks.filter(t=>t.inPool&&!t.done);
  if(!appstate.poolTasks?.length&&poolable.length) appstate.poolTasks=poolable.slice(0,4).map(t=>t._id?.toString());
  if(!Object.keys(appstate.poolAssignments||{}).length) appstate.poolAssignments=buildPoolAssignments(appstate.poolTasks||[]);
  let toShow=(appstate.poolTasks||[]).map(id=>tasks.find(t=>t._id?.toString()===id)).filter(Boolean).filter(t=>!t.done);
  if(pf!=='all') toShow=toShow.filter(t=>appstate.poolAssignments?.[t._id?.toString()]?.assignedUser===pf);
  const c=document.getElementById('poolContainer');
  if(!toShow.length){c.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ²</div><div class="empty-title">Keine Aufgaben</div><div class="empty-sub">Pool ist leer.</div></div>`;return;}
  c.innerHTML=toShow.map(t=>{
    const id=t._id?.toString(),asgn=appstate.poolAssignments?.[id],u=userById(asgn?.assignedUser),col=u?.color||'#9CA3AF';
    const subs=t.subtasks?.length?`<div style="margin-top:10px;border-top:1px solid var(--sep);padding-top:8px">${t.subtasks.map(s=>{const su=userById(asgn?.subtaskAssignments?.[s.id]);return`<div style="display:flex;align-items:center;gap:8px;padding:3px 0;font-size:12px"><span style="color:${s.done?'var(--green)':'var(--sep)'};font-size:14px">${s.done?'âœ“':'â—‹'}</span><span style="flex:1;${s.done?'text-decoration:line-through;color:var(--text3)':'color:var(--text2)'}">${s.title}</span>${su?`<span style="color:${su.color};font-weight:600">${su.name}</span>`:''}</div>`;}).join('')}</div>`:'';
    return`<div class="pool-card" style="border-left:3px solid ${col}" onclick="openDetail('${id}')">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
        <div style="font-size:15px;font-weight:600;flex:1;color:var(--text)">${catIcon(t.cat)} ${t.title}</div>
        <div style="display:flex;align-items:center;gap:5px;padding-left:8px">${avatarHTML(u,24)}<span style="font-size:12px;font-weight:600;color:${col}">${u?.name||'?'}</span></div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap"><span class="badge ${PRIO_CLASS[t.prio]||'b-ora'}">${t.prio}</span>${t.deadline?`<span class="badge b-blu">ğŸ“… ${fmtDate(t.deadline)}</span>`:''}</div>
      ${progHTML(t)}${subs}
    </div>`;
  }).join('');
}
function setPoolFilter(id){appstate.poolFilter=id;saveAppstate();renderPool();}

function shufflePool() {
  const poolable=tasks.filter(t=>t.inPool&&!t.done);
  if(!poolable.length){showToast('Keine Pool-Aufgaben.');return;}
  appstate.poolTasks=shuffleArr(poolable).slice(0,Math.min(4,poolable.length)).map(t=>t._id?.toString());
  appstate.poolAssignments=buildPoolAssignments(appstate.poolTasks);
  appstate.poolFilter='all'; saveAppstate();
  // Show shuffle effect
  const msgs=SHUFFLE_MSGS, msg=msgs[Math.floor(Math.random()*msgs.length)];
  document.getElementById('shuffleMsg').textContent=msg;
  document.getElementById('shuffleOv').classList.add('show');
  setTimeout(closeShuffleOv,2800);
  renderPool(); renderMyTasks();
}
function closeShuffleOv(){document.getElementById('shuffleOv').classList.remove('show');}

// â”€â”€ CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCalendar() {
  document.getElementById('calMonthLabel').textContent=new Date(calYear,calMonth).toLocaleDateString('de-DE',{month:'long',year:'numeric'});
  const today=new Date();today.setHours(0,0,0,0);
  const firstDay=new Date(calYear,calMonth,1),startDow=firstDay.getDay()===0?6:firstDay.getDay()-1;
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate(),daysInPrev=new Date(calYear,calMonth,0).getDate();
  const deadlineMap={};
  tasks.filter(t=>t.deadline&&visibleToMe(t)).forEach(t=>{if(!deadlineMap[t.deadline])deadlineMap[t.deadline]=[];deadlineMap[t.deadline].push(t);});
  const days=['Mo','Di','Mi','Do','Fr','Sa','So'];
  let html=days.map(d=>`<div class="cal-dn">${d}</div>`).join('');
  const total=Math.ceil((startDow+daysInMonth)/7)*7;
  for(let i=0;i<total;i++){
    let day,mo=calMonth,yr=calYear,other=false;
    if(i<startDow){day=daysInPrev-startDow+i+1;mo=calMonth-1;other=true;if(mo<0){mo=11;yr--;}}
    else if(i>=startDow+daysInMonth){day=i-startDow-daysInMonth+1;mo=calMonth+1;other=true;if(mo>11){mo=0;yr++;}}
    else{day=i-startDow+1;}
    const ds=`${yr}-${String(mo+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const isToday=new Date(ds+'T00:00:00').getTime()===today.getTime();
    const isSel=ds===calSelectedDay;
    const dt=deadlineMap[ds]||[];
    const dots=dt.slice(0,3).map(t=>`<div class="cal-dot" style="background:${userColor(t.assignee)}"></div>`).join('');
    const numClass=`cal-num${isToday?' today':isSel?' sel':other?' other-month':''}`;
    html+=`<div class="cal-cell" onclick="calSelectDay('${ds}')"><div class="${numClass}">${day}</div><div class="cal-dots">${dots}</div></div>`;
  }
  document.getElementById('calGrid').innerHTML=html;
  // Task list below calendar
  renderCalTaskList();
}

function calSelectDay(d) { calSelectedDay = calSelectedDay===d ? null : d; renderCalendar(); }
function calPrev(){calMonth--;if(calMonth<0){calMonth=11;calYear--;}renderCalendar();}
function calNext(){calMonth++;if(calMonth>11){calMonth=0;calYear++;}renderCalendar();}

function renderCalTaskList() {
  const c=document.getElementById('calTaskList');
  if (calSelectedDay) {
    // Show tasks for selected day
    const dt=tasks.filter(t=>t.deadline===calSelectedDay&&visibleToMe(t));
    if(!dt.length){c.innerHTML=`<div style="padding:12px 14px;color:var(--text3);font-size:14px">Keine Aufgaben an diesem Tag.</div>`;return;}
    c.innerHTML=`<div class="sec-label">ğŸ“… ${fmtDate(calSelectedDay)}</div><div class="card-group">${dt.map(t=>taskHTML(t,true)).join('')}</div>`;
  } else {
    // Show ALL tasks with deadlines, chronologically
    const all=tasks.filter(t=>t.deadline&&visibleToMe(t)).sort((a,b)=>a.deadline.localeCompare(b.deadline));
    if(!all.length){c.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ“…</div><div class="empty-title">Keine Deadlines</div><div class="empty-sub">Aufgaben mit Deadline erscheinen hier.</div></div>`;return;}
    // Group by date
    const byDate={};
    all.forEach(t=>{if(!byDate[t.deadline])byDate[t.deadline]=[];byDate[t.deadline].push(t);});
    let html='';
    Object.entries(byDate).sort(([a],[b])=>a.localeCompare(b)).forEach(([date,dt])=>{
      const overdue=new Date(date+'T00:00:00')<new Date()&&date!==todayStr();
      html+=`<div class="sec-label" style="${overdue?'color:var(--red)':''}">ğŸ“… ${fmtDate(date)}${overdue?' âš ï¸ ÃœberfÃ¤llig':''}</div><div class="card-group">${dt.map(t=>taskHTML(t,true)).join('')}</div>`;
    });
    c.innerHTML=html;
  }
}

// â”€â”€ USERS/GROUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderUsers() {
  const gc=document.getElementById('groupContainer');
  if(group){
    gc.innerHTML=`<div class="sec-label">Gruppe</div><div class="card-group">
      <div class="card-row">
        <div style="font-size:28px">${group.name[0]}</div>
        <div style="flex:1"><div style="font-size:15px;font-weight:600">${group.name}</div><div style="font-size:12px;color:var(--text3)">Code: <b>${group.inviteCode}</b></div></div>
        ${group.creatorId===me._id?.toString()?`<button onclick="editGroup()" style="background:var(--card2);border:1px solid var(--sep);border-radius:8px;padding:5px 10px;font-size:12px;cursor:pointer;color:var(--text2)">âœï¸</button>`:''}
      </div>
    </div>`;
  } else {
    gc.innerHTML=`<div class="sec-label">Gruppe</div><div style="padding:0 14px 14px;display:flex;flex-direction:column;gap:8px"><button class="btn btn-p" style="font-size:15px" onclick="createGroupFromProfile()">+ Gruppe erstellen</button><button class="btn btn-outline" onclick="joinGroupFromProfile()">Gruppe beitreten</button></div>`;
  }
  const uc=document.getElementById('usersContainer');
  uc.innerHTML=`<div class="card-group">${users.map(u=>{
    const isMe=u._id?.toString()===me._id?.toString();
    const tc=tasks.filter(t=>(t.assignee===u._id?.toString()||t.assignee==='all')&&!t.done).length;
    return`<div class="card-row">${avatarHTML(u)}<div style="flex:1"><div style="font-size:15px;font-weight:500">${u.name}${isMe?' <span style="font-size:11px;color:var(--green);font-weight:600">â— Du</span>':''}</div><div style="font-size:12px;color:var(--text3)">${tc} offene Aufgabe${tc!==1?'n':''}</div></div>${isMe?`<button onclick="openProfile()" style="background:var(--card2);border:1px solid var(--sep);border-radius:8px;padding:5px 10px;font-size:12px;cursor:pointer;color:var(--text2)">âœï¸</button>`:''}</div>`;
  }).join('')}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDetail(id) {
  const t=tasks.find(t=>t._id?.toString()===id); if(!t)return;
  currentDetailId=id;
  const asgn=appstate.poolAssignments?.[id];
  const eff=t.assignee==='all'&&asgn?asgn.assignedUser:t.assignee;
  const u=userById(eff); const col=userColor(eff);
  const aname=eff==='all'?'ğŸ‘¥ Alle':(u?u.name:'');
  const overdue=t.deadline&&!t.done&&new Date(t.deadline+'T00:00:00')<new Date();
  const subsH=t.subtasks?.length?`<div class="sec-label">Unteraufgaben (${t.subtasks.filter(s=>s.done).length}/${t.subtasks.length})</div>
    <div class="card-group" id="detailSubList">
      ${t.subtasks.map(s=>`<div class="sub-item" data-sid="${s.id}"><span class="drag-h">â ¿</span><div class="sub-chk ${s.done?'done':''}" onclick="toggleSub('${id}','${s.id}')">${s.done?'âœ“':''}</div><span style="flex:1;font-size:14px;${s.done?'text-decoration:line-through;color:var(--text3)':''}">${s.title}</span></div>`).join('')}
      <div class="card-row" onclick="addSubFromDetail('${id}')"><span style="color:var(--accent);font-size:18px;font-weight:300">+</span><span style="color:var(--accent);font-size:14px">Unteraufgabe hinzufÃ¼gen</span></div>
    </div>`:`<div style="padding:0 14px 8px"><button class="btn btn-g" onclick="addSubFromDetail('${id}')">+ Unteraufgabe</button></div>`;
  document.getElementById('taskDetailContent').innerHTML=`
    <div style="padding:16px 14px 10px">
      <div style="font-size:22px;font-weight:700;letter-spacing:-.4px;margin-bottom:10px;line-height:1.3">${t.title}</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap"><span class="badge ${PRIO_CLASS[t.prio]||'b-ora'}">${t.prio}</span><span class="badge b-blu">${catIcon(t.cat)} ${t.cat}</span>${t.done?'<span class="badge b-grn">âœ“ Erledigt</span>':''}${t.repeat&&t.repeat!=='Nie'?`<span class="badge b-rec">ğŸ” ${t.repeat}</span>`:''}</div>
      ${t.desc?`<div style="font-size:14px;color:var(--text2);line-height:1.6;margin-top:12px">${t.desc}</div>`:''}
    </div>
    ${t.subtasks?.length?`<div style="padding:0 14px 4px">${progHTML(t)}</div>`:''}
    <div class="sec-label">Details</div>
    <div class="card-group">
      <div class="card-row" style="cursor:default"><span style="font-size:16px">ğŸ‘¤</span><span style="flex:1;font-size:14px;color:var(--text2)">ZustÃ¤ndig</span><span style="color:${col};font-weight:600;font-size:14px">${aname}</span></div>
      ${t.deadline?`<div class="card-row" style="cursor:default"><span style="font-size:16px">ğŸ“…</span><span style="flex:1;font-size:14px;color:var(--text2)">Deadline</span><span style="font-size:14px;color:${overdue?'var(--red)':'var(--text3)'}">${fmtDate(t.deadline)}${overdue?' âš ï¸':''}</span></div>`:''}
      ${t.inPool?`<div class="card-row" style="cursor:default"><span style="font-size:16px">ğŸ²</span><span style="flex:1;font-size:14px;color:var(--text2)">Im Pool</span><span style="color:var(--green);font-size:14px">Ja</span></div>`:''}
    </div>
    ${subsH}
    <div style="padding:8px 14px 4px"><button class="btn btn-p" onclick="toggleTask('${id}',true)">${t.done?'Wieder Ã¶ffnen':'Als erledigt markieren'}</button></div>
    <div style="padding:4px 14px 24px"><button class="btn btn-d" onclick="detailConfirmDelete('${id}')">Aufgabe lÃ¶schen</button></div>`;
  document.getElementById('taskDetail').classList.add('open');
  if(t.subtasks?.length) setTimeout(()=>initSubDrag(id),60);
}
function closeDetail(){document.getElementById('taskDetail').classList.remove('open');}
function editCurrentTask(){if(currentDetailId){closeDetail();setTimeout(()=>showAddTask(currentDetailId),240);}}
function detailConfirmDelete(id) {
  if(!confirm('Aufgabe wirklich lÃ¶schen?'))return;
  api('DELETE','/tasks/'+id).then(()=>{tasks=tasks.filter(t=>t._id?.toString()!==id);saveAppstate();render();closeDetail();showToast('ğŸ—‘ï¸ GelÃ¶scht');}).catch(e=>showToast('Fehler: '+e.message));
}
async function toggleSub(taskId,subId){
  const t=tasks.find(t=>t._id?.toString()===taskId);if(!t)return;
  const s=t.subtasks?.find(s=>s.id===subId);if(s)s.done=!s.done;
  try{await api('PATCH','/tasks/'+taskId,{subtasks:t.subtasks});render();openDetail(taskId);}catch(e){showToast('Fehler');}
}
async function addSubFromDetail(taskId){
  const title=prompt('Unteraufgabe:');if(!title)return;
  const t=tasks.find(t=>t._id?.toString()===taskId);if(!t)return;
  if(!t.subtasks)t.subtasks=[];
  t.subtasks.push({id:uid(),title,done:false});
  await api('PATCH','/tasks/'+taskId,{subtasks:t.subtasks});render();openDetail(taskId);
}
function initSubDrag(taskId){
  const list=document.getElementById('detailSubList');if(!list)return;
  let dr=null;
  function getItems(){return[...list.querySelectorAll('.sub-item[data-sid]')];}
  function start(e){const h=e.target.closest('.drag-h');if(!h)return;e.preventDefault();dr=h.closest('.sub-item');if(dr)dr.classList.add('dragging');}
  function move(e){if(!dr)return;e.preventDefault();const y=e.touches?e.touches[0].clientY:e.clientY;const items=getItems().filter(i=>i!==dr);let t=null;for(const i of items){const r=i.getBoundingClientRect();if(y<r.top+r.height/2){t=i;break;}}const addBtn=list.querySelector('.card-row');if(t)list.insertBefore(dr,t);else if(addBtn)list.insertBefore(dr,addBtn);else list.appendChild(dr);}
  async function end(){if(!dr)return;dr.classList.remove('dragging');const t=tasks.find(t=>t._id?.toString()===taskId);if(t){const order=getItems().map(el=>el.dataset.sid);t.subtasks.sort((a,b)=>order.indexOf(a.id)-order.indexOf(b.id));await api('PATCH','/tasks/'+taskId,{subtasks:t.subtasks});}dr=null;}
  list.addEventListener('touchstart',start,{passive:false});list.addEventListener('touchmove',move,{passive:false});list.addEventListener('touchend',end);
  list.addEventListener('mousedown',start);window.addEventListener('mousemove',move);window.addEventListener('mouseup',end);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TASK TOGGLE (with crumple effect)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function toggleTask(id, withCeleb=false) {
  const t=tasks.find(t=>t._id?.toString()===id);if(!t)return;
  const wasDone=t.done; t.done=!t.done;
  // Crumple animation when completing
  if (!wasDone) {
    const el=document.getElementById('ti-'+id);
    if(el){el.classList.add('completing');setTimeout(()=>{render();},430);}
    else render();
    if(withCeleb) celebrate();
  } else { render(); }
  try{await api('PATCH','/tasks/'+id,{done:t.done});}
  catch(e){t.done=wasDone;render();showToast('Fehler');}
}
function toggleDoneFilter(){appstate.showDone=!appstate.showDone;saveAppstate();renderMyTasks();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TASK MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateCatDrop(){
  const sel=document.getElementById('taskCat');if(!sel)return;
  sel.innerHTML=Object.entries(allCats()).map(([n,i])=>`<option value="${n}">${i} ${n}</option>`).join('');
}
function refreshNewSubList(){
  const el=document.getElementById('newSubList');if(!el)return;
  el.innerHTML=newSubs.map((s,i)=>`<div class="new-sub-tag"><span class="drag-h" style="cursor:grab">â ¿</span><span style="flex:1;font-size:13px">${s.title}</span><button class="rm-btn" onclick="removeNewSub(${i})">Ã—</button></div>`).join('');
}
function addNewSub(){const inp=document.getElementById('newSubInput');const v=inp.value.trim();if(!v)return;newSubs.push({id:uid(),title:v,done:false});inp.value='';refreshNewSubList();}
function removeNewSub(i){newSubs.splice(i,1);refreshNewSubList();}
function onAssigneeChange(sel){if(sel.value==='all')document.getElementById('poolToggle').classList.add('on');}

function showAddTask(editId=null){
  editingTaskId=editId;
  const t=editId?tasks.find(t=>t._id?.toString()===editId):null;
  newSubs=t?[...(t.subtasks||[])].map(s=>({...s})):[];
  populateCatDrop();
  document.getElementById('modalTitle').textContent=editId?'Aufgabe bearbeiten':'Neue Aufgabe';
  document.getElementById('taskTitle').value=t?.title||'';
  document.getElementById('taskDesc').value=t?.desc||'';
  document.getElementById('taskCat').value=t?.cat||'Arbeit';
  document.getElementById('taskDeadline').value=t?.deadline||'';
  document.getElementById('taskRepeat').value=t?.repeat||'Nie';
  selectedPrio=t?.prio||'Mittel';
  document.querySelectorAll('#prioCtrl .seg-b').forEach((b,i)=>b.classList.toggle('on',['Hoch','Mittel','Niedrig'][i]===selectedPrio));
  document.getElementById('poolToggle').className='toggle'+(t?.inPool?' on':'');
  const sel=document.getElementById('taskAssignee');
  sel.innerHTML=`<option value="all">ğŸ‘¥ Alle Nutzer</option>`+users.map(u=>`<option value="${u._id}">${u.name}</option>`).join('');
  sel.value=t?.assignee||me._id?.toString()||'all';
  document.getElementById('delTaskRow').innerHTML=editId?`<button class="btn btn-d" onclick="deleteTaskFromModal('${editId}')">Aufgabe lÃ¶schen</button>`:'';
  refreshNewSubList();
  document.getElementById('newSubInput').value='';
  document.getElementById('taskModal').classList.add('open');
}
function closeTaskModal(){document.getElementById('taskModal').classList.remove('open');}
function setPrio(p,el){selectedPrio=p;document.querySelectorAll('#prioCtrl .seg-b').forEach(b=>b.classList.remove('on'));el.classList.add('on');}

async function saveTask(){
  const title=document.getElementById('taskTitle').value.trim();
  if(!title){showToast('âš ï¸ Titel eingeben!');return;}
  const assignee=document.getElementById('taskAssignee').value;
  const inPool=document.getElementById('poolToggle').classList.contains('on');
  const wasForOther=assignee!=='all'&&assignee!==me._id?.toString();
  const data={title,desc:document.getElementById('taskDesc').value,cat:document.getElementById('taskCat').value,prio:selectedPrio,deadline:document.getElementById('taskDeadline').value,assignee,repeat:document.getElementById('taskRepeat').value,repeatStart:todayStr(),inPool:inPool||assignee==='all',done:false,subtasks:[...newSubs]};
  try{
    if(editingTaskId){
      await api('PATCH','/tasks/'+editingTaskId,data);
      const idx=tasks.findIndex(t=>t._id?.toString()===editingTaskId);if(idx>=0)tasks[idx]={...tasks[idx],...data};
    }else{
      const created=await api('POST','/tasks',data);tasks.push(created);
      if(wasForOther)showToast('ğŸ“¨ An '+userById(assignee)?.name+' gesendet!');
    }
    newSubs=[];saveAppstate();render();closeTaskModal();showToast(editingTaskId?'âœ… Gespeichert':'âœ… Erstellt');
  }catch(e){showToast('Fehler: '+e.message);}
}

function deleteTaskFromModal(id){
  if(!confirm('Aufgabe wirklich lÃ¶schen?'))return;
  api('DELETE','/tasks/'+id).then(()=>{tasks=tasks.filter(t=>t._id?.toString()!==id);saveAppstate();render();closeTaskModal();showToast('ğŸ—‘ï¸ GelÃ¶scht');}).catch(e=>showToast('Fehler: '+e.message));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROFILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openProfile(){
  profilePhotoData=me.photo||null;
  document.getElementById('profileName').value=me.name;
  const pa=document.getElementById('profilePhotoArea');
  pa.innerHTML=me.photo?`<img src="${me.photo}">`:`<div style="width:100%;height:100%;background:${me.color};display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;color:#fff">${me.name[0]}</div>`;
  // Colors
  const cg=document.getElementById('profileColorGrid');
  cg.innerHTML=ALL_COLORS.map(c=>`<div class="cdot${me.color===c?' sel':''}" style="background:${c}" onclick="pickProfileColor('${c}',this)"></div>`).join('');
  // Theme seg
  const themeMap={'':'0','th-dark':'1','th-warm':'2'};
  const idx=themeMap[me.theme||'']||'0';
  document.querySelectorAll('#themeSegCtrl .seg-b').forEach((b,i)=>b.classList.toggle('on',i===parseInt(idx)));
  // Color overrides
  const others=users.filter(u=>u._id?.toString()!==me._id?.toString());
  document.getElementById('colorOverrideSection').innerHTML=others.length?`<label class="fl">Farben der anderen Nutzer (nur fÃ¼r dich)</label>`+others.map(u=>{
    const ovr=me.colorOverrides?.[u._id?.toString()]||u.color;
    return`<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">${avatarHTML(u,32)}<span style="flex:1;font-size:14px;font-weight:500">${u.name}</span><div style="display:flex;gap:5px;flex-wrap:wrap;max-width:160px">${ALL_COLORS.slice(0,12).map(c=>`<div class="cdot${ovr===c?' sel':''}" style="background:${c};width:22px;height:22px;border-width:2px" onclick="pickOverrideColor('${u._id}','${c}',this)"></div>`).join('')}</div></div>`;
  }).join(''):'';
  // Group
  const gs=document.getElementById('groupInfoSection');
  if(group){gs.innerHTML=`<label class="fl">Gruppe</label><div class="fi" style="font-size:14px"><b>${group.name}</b> Â· Code: <b style="letter-spacing:1px">${group.inviteCode}</b></div>`;document.getElementById('leaveGroupRow').innerHTML=`<button class="btn btn-d" onclick="leaveGroup()">Gruppe verlassen</button>`;}
  else{gs.innerHTML='';document.getElementById('leaveGroupRow').innerHTML='';}
  document.getElementById('profileModal').classList.add('open');
}
function closeProfile(){document.getElementById('profileModal').classList.remove('open');}
function pickProfileColor(c,el){me.color=c;document.querySelectorAll('#profileColorGrid .cdot').forEach(d=>d.classList.remove('sel'));el.classList.add('sel');}
function pickOverrideColor(uid,color,el){if(!me.colorOverrides)me.colorOverrides={};me.colorOverrides[uid]=color;const par=el.closest('div[style*="display:flex;gap:5px"]');if(par)par.querySelectorAll('.cdot').forEach(d=>d.classList.toggle('sel',d.style.background===color));}
function handleProfilePhoto(input){const f=input.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{profilePhotoData=e.target.result;document.getElementById('profilePhotoArea').innerHTML=`<img src="${profilePhotoData}">`};r.readAsDataURL(f);}
async function saveProfile(){
  const name=document.getElementById('profileName').value.trim();
  try{me=await api('PATCH','/users/me',{name:name||me.name,color:me.color,photo:profilePhotoData,colorOverrides:me.colorOverrides||{},theme:me.theme||''});
  const idx=users.findIndex(u=>u._id?.toString()===me._id?.toString());if(idx>=0)users[idx]={...users[idx],...me};
  applyTheme();render();closeProfile();showToast('âœ… Profil gespeichert');}
  catch(e){showToast('Fehler: '+e.message);}
}
async function leaveGroup(){if(!confirm('Gruppe verlassen?'))return;try{await api('POST','/groups/leave');group=null;me.groupId=null;await loadAll();render();closeProfile();showToast('Gruppe verlassen');}catch(e){showToast('Fehler: '+e.message);}}
async function deleteAccount(){if(!confirm('Account wirklich lÃ¶schen?'))return;try{await api('DELETE','/users/me');localStorage.removeItem('tf_token');location.reload();}catch(e){showToast('Fehler: '+e.message);}}
function createGroupFromProfile(){const name=prompt('Gruppenname:');if(!name)return;api('POST','/groups',{name}).then(async g=>{group=g;me=await api('GET','/users/me');await loadAll();render();showToast('ğŸ  Code: '+g.inviteCode);}).catch(e=>showToast('Fehler: '+e.message));}
function joinGroupFromProfile(){const code=prompt('Einladungscode:');if(!code)return;api('POST','/groups/join',{inviteCode:code.trim().toUpperCase()}).then(async g=>{group=g;me=await api('GET','/users/me');await loadAll();render();showToast('ğŸ‰ Beigetreten!');}).catch(e=>showToast('Fehler: '+e.message));}
function editGroup(){const name=prompt('Neuer Gruppenname:',group.name);if(!name)return;api('PATCH','/groups/mine',{name}).then(()=>{group.name=name;renderUsers();showToast('âœ… Aktualisiert');}).catch(e=>showToast('Fehler: '+e.message));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAdminModal(){document.getElementById('adminPinInput').value='';document.getElementById('adminContent').innerHTML=document.getElementById('adminContent').innerHTML;document.getElementById('adminModal').classList.add('open');}
function closeAdminModal(){document.getElementById('adminModal').classList.remove('open');verifiedAdminPin=null;}

async function verifyAdminPin(){
  const pin=document.getElementById('adminPinInput').value.trim();
  if(!pin){showToast('PIN eingeben');return;}
  try{
    await api('POST','/admin/verify',{pin});
    verifiedAdminPin=pin;
    const data=await api('GET',`/admin/data?pin=${encodeURIComponent(pin)}`);
    renderAdminDashboard(data);
  }catch(e){showToast('âŒ Falscher PIN');}
}

function renderAdminDashboard(data){
  const userRows=data.users.map(u=>`
    <div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:8px;border:1px solid var(--sep)">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
        <div class="av" style="width:36px;height:36px;background:${u.color||'#9CA3AF'};font-size:14px">${u.name?.[0]||'?'}</div>
        <div style="flex:1"><div style="font-size:14px;font-weight:600">${u.name}</div><div style="font-size:11px;color:var(--text3)">${u.createdAt?new Date(u.createdAt).toLocaleDateString('de-DE'):''}</div></div>
        <span class="badge ${u.groupName==='Solo'?'b-pur':'b-blu'}">${u.groupName}</span>
      </div>
      <div style="display:flex;gap:8px;font-size:12px;color:var(--text3)">
        <span>ğŸ“‹ ${u.taskCount} Aufgaben</span>
        ${u.groupCode!=='â€“'?`<span>ğŸ”‘ ${u.groupCode}</span>`:''}
        ${u.solo?'<span>ğŸ‘¤ Solo</span>':''}
      </div>
    </div>`).join('');
  document.getElementById('adminContent').innerHTML=`
    <div style="padding:0 16px 8px">
      <div style="display:flex;gap:10px;margin-bottom:16px">
        <div style="flex:1;background:var(--accent-soft);border-radius:11px;padding:12px;text-align:center"><div style="font-size:24px;font-weight:700;color:var(--accent)">${data.users.length}</div><div style="font-size:11px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.4px">Nutzer</div></div>
        <div style="flex:1;background:var(--card2);border-radius:11px;padding:12px;text-align:center"><div style="font-size:24px;font-weight:700">${data.groups.length}</div><div style="font-size:11px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.4px">Gruppen</div></div>
        <div style="flex:1;background:var(--card2);border-radius:11px;padding:12px;text-align:center"><div style="font-size:24px;font-weight:700">${data.totalTasks}</div><div style="font-size:11px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.4px">Aufgaben</div></div>
      </div>
      <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:10px">Alle Nutzer</div>
      ${userRows}
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSettings(){renderCustomCats();document.getElementById('settingsOv').classList.add('open');}
function closeSettings(){document.getElementById('settingsOv').classList.remove('open');}
function renderCustomCats(){
  const list=document.getElementById('customCatList');
  const customs=Object.entries(appstate.customCats||{});
  if(!customs.length){list.innerHTML=`<div style="color:var(--text3);font-size:13px;padding-bottom:8px">Noch keine eigenen Kategorien.</div>`;return;}
  list.innerHTML=customs.map(([name,icon])=>`
    <div style="display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--sep)">
      <span style="font-size:18px">${icon}</span><span style="flex:1;font-size:14px">${name}</span>
      <button onclick="removeCustomCat('${name}')" style="background:none;border:none;color:var(--red);font-size:17px;cursor:pointer;padding:2px 4px">Ã—</button>
    </div>`).join('');
}
function addCustomCat(){
  const emoji=document.getElementById('newCatEmoji').value.trim()||'ğŸ“Œ';
  const name=document.getElementById('newCatName').value.trim();
  if(!name){showToast('Name eingeben!');return;}
  // Check if used by any task
  if(!appstate.customCats)appstate.customCats={};
  appstate.customCats[name]=emoji;
  document.getElementById('newCatEmoji').value='';document.getElementById('newCatName').value='';
  saveAppstate();renderCustomCats();populateCatDrop();showToast(`âœ… "${name}" hinzugefÃ¼gt`);
}
function removeCustomCat(name){
  const inUse=tasks.some(t=>t.cat===name);
  if(inUse){showToast(`âš ï¸ "${name}" wird noch von einer Aufgabe verwendet`);return;}
  if(appstate.customCats)delete appstate.customCats[name];
  saveAppstate();renderCustomCats();showToast(`"${name}" gelÃ¶scht`);
}
async function resetTasks(){
  if(!confirm('Alle Aufgaben lÃ¶schen?'))return;
  for(const t of [...tasks]){try{await api('DELETE','/tasks/'+t._id);}catch(e){}}
  tasks=[];appstate.poolTasks=[];appstate.poolAssignments={};
  saveAppstate();render();closeSettings();showToast('ğŸ—‘ï¸ Alle gelÃ¶scht');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CELEBRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function celebrate(){
  const faces=['ğŸ˜„','ğŸ˜','ğŸ¥³','ğŸ˜','ğŸ¤©','ğŸ˜œ','ğŸ‰'];
  document.getElementById('celebFace').textContent=faces[Math.floor(Math.random()*faces.length)];
  document.getElementById('celebTxt').textContent=CELEB_MSGS[Math.floor(Math.random()*CELEB_MSGS.length)];
  const cc=document.getElementById('confContainer');cc.innerHTML='';
  const cols=['#5B5BD6','#22C55E','#EF4444','#F59E0B','#8B5CF6','#FBBF24'];
  for(let i=0;i<50;i++){const p=document.createElement('div');p.className='conf';p.style.cssText=`left:${Math.random()*100}%;background:${cols[Math.floor(Math.random()*cols.length)]};width:${5+Math.random()*7}px;height:${5+Math.random()*7}px;border-radius:${Math.random()>.5?'50%':'2px'};animation-duration:${1.4+Math.random()*2}s;animation-delay:${Math.random()*.5}s`;cc.appendChild(p);}
  document.getElementById('celebOv').classList.add('show');
  setTimeout(closeceleb,4000);
}
function closeceleb(){document.getElementById('celebOv').classList.remove('show');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastT;
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(toastT);toastT=setTimeout(()=>t.classList.remove('show'),2800);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS + SWIPE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(i,animate=true){
  currentTab=i;
  const wrap=document.getElementById('pagesWrap');
  if(!animate)wrap.classList.add('no-anim');
  wrap.style.transform=`translateX(-${i*20}%)`;
  if(!animate){requestAnimationFrame(()=>{requestAnimationFrame(()=>wrap.classList.remove('no-anim'));});}
  document.querySelectorAll('.tab').forEach((t,j)=>t.classList.toggle('active',j===i));
  document.getElementById('navTitle').textContent=NAV_TITLES[i];
  document.getElementById('fabBtn').style.display=i===4?'none':'';
  if(i===3)renderCalendar();
}

// Touch swipe
let swipeStartX=null,swipeStartY=null;
document.addEventListener('touchstart',e=>{swipeStartX=e.touches[0].clientX;swipeStartY=e.touches[0].clientY;},{passive:true});
document.addEventListener('touchend',e=>{
  if(swipeStartX===null)return;
  const dx=e.changedTouches[0].clientX-swipeStartX;
  const dy=e.changedTouches[0].clientY-swipeStartY;
  if(Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>50){
    // Ignore if modal is open
    const anyOpen=[...document.querySelectorAll('.ov.open,.detail-ov.open')].length;
    if(anyOpen)return;
    if(dx<0&&currentTab<4)switchTab(currentTab+1);
    else if(dx>0&&currentTab>0)switchTab(currentTab-1);
  }
  swipeStartX=null;swipeStartY=null;
},{passive:true});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function uid(){return Math.random().toString(36).substr(2,9);}
function shuffleArr(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function fmtDate(d){if(!d)return'';return new Date(d+'T00:00:00').toLocaleDateString('de-DE',{day:'numeric',month:'short',year:'numeric'});}

init();
</script>
</body>
</html>
